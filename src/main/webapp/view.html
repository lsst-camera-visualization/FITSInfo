<html>
    <head>
        <title>LSST Camera Image Viewer</title>
        <script src="openseadragon/openseadragon.min.js"></script>
        <script src="openseadragon/plugins/openseadragonScreenshot.js"></script>
        <script src="openseadragon/plugins/FileSaver.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <style>
            .toolbar
            {
                width:      100%;
                border:     none;
                color:      #333;
                padding:    4px;
                background-color: transparent;
            }
            .toolbar.fullpage{
                width:      100%;
                border:     none;
                position:   fixed;
                z-index:    999999;
                left:       0;
                top:        0;
                background-color: #ccc;
            }
            .overlay-sensor {
                font-size: 12pt;
                color: red;
                font-weight: bold;
            }
            .overlay-segment {
                font-size: 12pt;
                color: blue;
                font-weight: bold;
            }
            .buttonGroup {
                border: none;
                margin: 0px;
                padding: 0px;
                display: inline-block;
                vertical-align: middle;
            }
            .osd-view {
                background-color: blue;
            }
            body {
                height: 100%;
                margin: 0;
            }
            .box {
                display: flex;
                flex-flow: column;
                height: 100%;
            }
            .openseadragon-container {
                display: flex;
                flex-flow: column;
                flex: 1 1 auto;
            }
            .openseadragon-canvas {
                flex: 1 1 auto;
            }
            .box .content {
                flex: 1 1 auto;
            }
            .field {
                white-space: nowrap;
            }
            a.menu_icon i {
                color: #000;
                font-size: 40px;
                padding-top: 5px;
                transition: .2s ease;
            }
            a.menu_icon:hover i {
                color: #aaa;
            }
            nav.menu {
                width: 300px;
                min-height: calc(100vh - 121px);
                background-color: #03a9f4;
                position: absolute;
                left: -300px;
                transition: .3s all;
            }
            nav.menu > a {
                display: block;
                padding: 5px;
                margin: 15px 0 0px 20px;
                color: #494949;
            }
            .menu_show {
                left: 0!important;
            }

            #datastrip {
                position: fixed;
                right: 0;
                bottom:0;
                background: #ccd;
                color: #334;
            }
            #datastrip > * {
                display: inline-block;
            }
            #xy-coord {
                width: 400px;
            }
            #color-array {
                width: 8em;
                padding: 2px 4px;
            }
            #color-spot {
                width: 1em;
                height: 1em;
                vertical-align: -.133em;
            }
        </style>
    </head>
    <body>
        <div class="box">
            <h1>LSST Camera Image Viewer</h1>
            <div id="viewer-area" class="box content">
                <div id="toolbarDiv" class="toolbar">
                    <!-- <a href="#" class="menu_icon" id="menu_icon"><i class="material-icons">dehaze</i></a> -->
                    <div id="buttons" class="buttonGroup"></div>
                    <span class="field">Image: <input type="text" id="imageName" size="18"></span>
                    <div id="nextPrev" class="buttonGroup"></div>
                    <span class="field">Raft: <select id="raft"></select></span>
                    <span class="field">Test Type: <input type="text" id="testType" size="8" readonly="readonly"></span>
                    <span class="field">Image Type: <input type="text" id="imageType" size="8" readonly="readonly"></span>
                    <span class="field">Exposure Time: <input type="text" id="exposureTime" size="8" readonly="readonly"></span>
                    <span class="field">Dark Time: <input type="text" id="darkTime" size="8" readonly="readonly"></span>
                    <span class="field" id="runField">Run: <input type="text" id="run" size="5" readonly="readonly"></span>                    
                    <span class="field">Time: <input type="text" id="time" size="15" readonly="readonly"></span>
                    <span class="field">Color: <select id="color"></select></span>
                    <span class="field" id="sourceField">Source: <select id="source"></select></span>
                    <span class="field" id="biasField">Bias: <select id="bias"></select></span>
                    <span class="field" id="scaleField">Scale: <select id="scale"></select></span>
                    <label for="showLatest">Auto Update: <input type="checkbox" id="showLatest"></label>
                </div>            
                <div id="osd-view" class="openseadragon content box">
                    <script type="text/javascript">
                        'use strict';
                        let iif2 = "https://lsst-camera.slac.stanford.edu/iiif/2/";
                        let geometry = [];
                        let urlParams = new URLSearchParams(window.location.search);
                        let imageName = urlParams.get('image');
                        let raftName = urlParams.get('raft');
                        let colorMap = urlParams.get('color');
                        let bias = urlParams.get('bias');
                        let scale = urlParams.get('scale');
                        let source = urlParams.get('source');
                        let site = "maincamera";
                        let view = urlParams.get('view');
                        let timerId = null;
                        $("#sourceField").hide();
                        if (view === "Tucson") {
                            iif2 = "http://comcam-dc01.tu.lsst.org:8182/iiif/2/";
                            raftName = "R22";
                            site = "tucson";
                            $("#runField").hide();
                        } else if (imageName.startsWith("AT_") || view === "AuxTel") {
                            iif2 = "http://auxtel-dc01.cp.lsst.org:8182/iiif/2/";
                            raftName = "R00";
                            site = "auxtel";
                            $("#runField").hide();
                            $("#sourceField").show();
                        } else if (imageName.startsWith("CC_") || view === "ComCam") {
                            iif2 = "http://comcam-vs01.cp.lsst.org:8182/iiif/2/";
                            raftName = "R22";
                            site = "comcam";
                            $("#runField").hide();
                        } else if (imageName.startsWith("MC_")) {
                            if (!raftName) raftName = "all";
                        }
                        let restURL = "rest/" + site + "/imageInfo/";
                        if (!raftName)
                            raftName = "R22";
                        let colorMaps = ["grey", "a", "b", "bb", "cubehelix0", "cubehelix1", "rainbow", "standard"];
                        if (!colorMap)
                            colorMap = colorMaps[0];
                        colorMaps.forEach(color => $("#color").append(`<option name="${color}">${color}</option>`));
                        let sources = ["raw", "RubinTV"];
                        if (!source)
                            source = sources[0];
                        sources.forEach(source => $("#source").append(`<option name="${source}">${source}</option>`));
                        let biases = ["Simple Overscan Correction", "None"];
                        if (!bias)
                            bias = biases[0];
                        biases.forEach(bias => $("#bias").append(`<option name="${bias}">${bias}</option>`));
                        let scales = ["Global", "Per-Segment"];
                        if (!scale)
                            scale = scales[1];
                        scales.forEach(scale => $("#scale").append(`<option name="${scale}">${scale}</option>`));
                        if (imageName === "latest") {
                            fetch(`${restURL}latest`)
                                .then((response) => response.json())
                                .then((myJson) => {
                                    imageName = myJson.image.obsId;
                                    osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                                    $('#showLatest').prop('checked', true);
                                    $("#showLatest").trigger("change");
                                });
                        }
                        let imageInfo = null;
                        let eventSource = null;

                        let homeButton = new OpenSeadragon.Button({
                            srcRest: "openseadragon/images/home_rest.png",
                            srcDown: "openseadragon/images/home_pressed.png",
                            srcHover: "openseadragon/images/home_hover.png",
                            srcGroup: "openseadragon/images/home_grouphover.png",
                            onClick: function (e) {
                                osd.viewport.goHome();
                            }
                        });


                        let zoomOutButton = new OpenSeadragon.Button({
                            srcRest: "openseadragon/images/zoomout_rest.png",
                            srcDown: "openseadragon/images/zoomout_pressed.png",
                            srcHover: "openseadragon/images/zoomout_hover.png",
                            srcGroup: "openseadragon/images/zoomout_grouphover.png",
                            onClick: function (e) {
                                osd.doSingleZoomOut();
                            }
                        });


                        let zoomInButton = new OpenSeadragon.Button({
                            srcRest: "openseadragon/images/zoomin_rest.png",
                            srcDown: "openseadragon/images/zoomin_pressed.png",
                            srcHover: "openseadragon/images/zoomin_hover.png",
                            srcGroup: "openseadragon/images/zoomin_grouphover.png",
                            onClick: function (e) {
                                osd.doSingleZoomIn();
                            }
                        });


                        let fullPageButton = new OpenSeadragon.Button({
                            srcRest: "openseadragon/images/fullpage_rest.png",
                            srcDown: "openseadragon/images/fullpage_pressed.png",
                            srcHover: "openseadragon/images/fullpage_hover.png",
                            srcGroup: "openseadragon/images/fullpage_grouphover.png",
                            onClick: function (e) {
                                osd.setFullScreen(!osd.isFullScreen());
                            }
                        });


                        let prevButton = new OpenSeadragon.Button({
                            tooltip: "Previous",
                            srcRest: "openseadragon/images/previous_rest.png",
                            srcDown: "openseadragon/images/previous_pressed.png",
                            srcHover: "openseadragon/images/previous_hover.png",
                            srcGroup: "openseadragon/images/previous_grouphover.png",
                            onClick: function (e) {
                                if (!e.eventSource.element.disabled) {
                                    imageName = imageInfo.previous;
                                    osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                                }
                            }
                        });

                        let nextButton = new OpenSeadragon.Button({
                            tooltip: "Next",
                            srcRest: "openseadragon/images/next_rest.png",
                            srcDown: "openseadragon/images/next_pressed.png",
                            srcHover: "openseadragon/images/next_hover.png",
                            srcGroup: "openseadragon/images/next_grouphover.png",
                            onClick: function (e) {
                                if (!e.eventSource.element.disabled) {
                                    imageName = imageInfo.next;
                                    osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                                }
                            }
                        });

                        let saveButton = new OpenSeadragon.Button({
                            tooltip: "Download current view",
                            srcRest: "openseadragon/images/snap_rest.png",
                            srcDown: "openseadragon/images/snap_pressed.png",
                            srcHover: "openseadragon/images/snap_hover.png",
                            srcGroup: "openseadragon/images/snap_grouphover.png",
                            onClick: function (e) {
                                screenshotInstance.takeScreenshot();
                            }
                        });

                        $('#imageName').on("keypress", function (e) {
                            if (e.keyCode === 13) {
                                imageName = $("#imageName").val();
                                osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                            }
                        });
                        $('#raft').on("change", function (e) {
                            raftName = $("#raft").val();
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        });
                        $('#color').on("change", function (e) {
                            colorMap = $("#color").val();
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        });
                        $('#source').on("change", function (e) {
                            source = $("#source").val();
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        });
                        $('#bias').on("change", function (e) {
                            bias = $("#bias").val();
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        });
                        $('#scale').on("change", function (e) {
                            scale = $("#scale").val();
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        });
                        $('#showLatest').on("change", (e) => {
                            const checked = $('#showLatest').is(":checked");
                            if (checked) {
                                eventSource = new EventSource("rest/" + site + "/notify");
                                eventSource.addEventListener("newImage", (event) => {
                                    imageName = event.lastEventId;
                                    osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                                });
                            } else {
                                eventSource.close();
                            }
                        });
                        new OpenSeadragon.ButtonGroup({buttons: [zoomInButton, zoomOutButton, homeButton, fullPageButton, saveButton], element: $("#buttons")[0]});
                        new OpenSeadragon.ButtonGroup({buttons: [prevButton, nextButton], element: $("#nextPrev")[0]});

                        const openHandler = function () {
                            $('#imageName').val(imageName);
                            $('#raft').val(raftName);
                            $('#color').val(colorMap);
                            $('#bias').val(bias);
                            $('#scale').val(scale);
                            $('#source').val(source);
                            let isRaw = source === 'raw';
                            $('#scale').prop('disabled', !isRaw);
                            $('#bias').prop('disabled', !isRaw);
                            nextButton.disable();
                            prevButton.disable();
                            let queryParams = new URLSearchParams(window.location.search);
                            queryParams.set("image", imageName);
                            queryParams.set("raft", raftName);
                            queryParams.set("color", colorMap);
                            queryParams.set("bias", bias);
                            queryParams.set("scale", scale);
                            queryParams.set("source", source);
                            history.replaceState(null, null, "?" + queryParams.toString());
                            fetch(`${restURL}${imageName}`)
                                .then((response) => response.json())
                                .then((myJson) => {
                                    imageInfo = myJson;
                                    let image = myJson.image;
                                    $("#run").val(image.runNumber);
                                    $("#imageType").val(image.imgType);
                                    $("#testType").val(image.testType);
                                    $("#exposureTime").val(image.exposureTime);
                                    $("#darkTime").val(image.darkTime);
                                    $("#time").val(new Date(image.obsDate).toISOString().slice(0, 19));
                                    $("#raft").empty();
                                    if (imageInfo.previous)
                                        prevButton.enable();
                                    if (imageInfo.next)
                                        nextButton.enable();
                                    let n = 0;
                                    for (let i = 0; i < 25; i++) {
                                        let raft = image.raftMask >> i & 1;
                                        if (raft) {
                                            let newRaft = "R" + Math.floor(i / 5) + (i % 5);
                                            let selected = raftName === newRaft ? "selected" : "";
                                            $("#raft").append(`<option ${selected}>${newRaft}</option>`);
                                            n++;
                                        }
                                    }
                                    if (n > 2) {
                                        let selected = raftName === 'all' ? "selected" : "";
                                        $("#raft").prepend(`<option ${selected}>all</option>`);
                                    }
                                });
                        };

                        class MyOpenSeadragon extends OpenSeadragon.Viewer {
                            constructor() {
                                super({
                                    id: "osd-view",
                                    prefixUrl: "openseadragon/images/",
                                    sequenceMode: false,
                                    showNavigator: true,
                                    toolbar: "toolbarDiv",
                                    homeButton: homeButton.element,
                                    fullPageButton: fullPageButton.element,
                                    zoomInButton: zoomInButton.element,
                                    zoomOutButton: zoomOutButton.element,
                                    preserveOverlays: true,
                                    preserveViewport: true,
                                    maxZoomPixelRatio: 2,
                                    crossOriginPolicy: true
                                });
                                this.multi = false;
                                this.geominfo = {};
                                this.identifier = null;

                                //TODO: This should not be hardwired here
                                const xRaft = 12688;
                                const yRaft = 12686;
                                this.multiGeom = {
                                    'R00': {'url': 'https://lsst-camera.slac.stanford.edu/dc10-iiif/2/', y: 0.8, x: 0.0, width: 0.2, ypixel: 0, xpixel: 0, raft: 'R00'}, 
                                    'R01': {'url': 'https://lsst-camera.slac.stanford.edu/dc06-iiif/2/', y: 0.8, x: 0.2, width: 0.2, ypixel: 0, xpixel: xRaft, raft: 'R01'}, 
                                    'R02': {'url': 'https://lsst-camera.slac.stanford.edu/dc08-iiif/2/', y: 0.8, x: 0.4, width: 0.2, ypixel: 0, xpixel: xRaft*2, raft: 'R02'}, 
                                    'R03': {'url': 'https://lsst-camera.slac.stanford.edu/dc09-iiif/2/', y: 0.8, x: 0.6, width: 0.2, ypixel: 0, xpixel: xRaft*3, raft: 'R03'}, 
                                    'R04': {'url': 'https://lsst-camera.slac.stanford.edu/dc10-iiif/2/', y: 0.8, x: 0.8, width: 0.2, ypixel: 0, xpixel: xRaft*4, raft: 'R04'}, 
                                    'R10': {'url': 'https://lsst-camera.slac.stanford.edu/dc04-iiif/2/', y: 0.6, x: 0.0, width: 0.2, ypixel: yRaft, xpixel: 0, raft: 'R10'}, 
                                    'R11': {'url': 'https://lsst-camera.slac.stanford.edu/dc06-iiif/2/', y: 0.6, x: 0.2, width: 0.2, ypixel: yRaft, xpixel: xRaft, raft: 'R11'}, 
                                    'R12': {'url': 'https://lsst-camera.slac.stanford.edu/dc03-iiif/2/', y: 0.6, x: 0.4, width: 0.2, ypixel: yRaft, xpixel: xRaft*2, raft: 'R12'},
                                    'R13': {'url': 'https://lsst-camera.slac.stanford.edu/dc05-iiif/2/', y: 0.6, x: 0.6, width: 0.2, ypixel: yRaft, xpixel: xRaft*3, raft: 'R13'}, 
                                    'R14': {'url': 'https://lsst-camera.slac.stanford.edu/dc07-iiif/2/', y: 0.6, x: 0.8, width: 0.2, ypixel: yRaft, xpixel: xRaft*4, raft: 'R14'}, 
                                    'R20': {'url': 'https://lsst-camera.slac.stanford.edu/dc04-iiif/2/', y: 0.4, x: 0.0, width: 0.2, ypixel: yRaft*2, xpixel: 0, raft: 'R20'}, 
                                    'R21': {'url': 'https://lsst-camera.slac.stanford.edu/dc07-iiif/2/', y: 0.4, x: 0.2, width: 0.2, ypixel: yRaft*2, xpixel: xRaft, raft: 'R21'}, 
                                    'R22': {'url': 'https://lsst-camera.slac.stanford.edu/dc03-iiif/2/', y: 0.4, x: 0.4, width: 0.2, ypixel: yRaft*2, xpixel: xRaft*2, raft: 'R22'}, 
                                    'R23': {'url': 'https://lsst-camera.slac.stanford.edu/dc09-iiif/2/', y: 0.4, x: 0.6, width: 0.2, ypixel: yRaft*2, xpixel: xRaft*3, raft: 'R23'}, 
                                    'R24': {'url': 'https://lsst-camera.slac.stanford.edu/dc07-iiif/2/', y: 0.4, x: 0.8, width: 0.2, ypixel: yRaft*2, xpixel: xRaft*4, raft: 'R24'}, 
                                    'R30': {'url': 'https://lsst-camera.slac.stanford.edu/dc08-iiif/2/', y: 0.2, x: 0.0, width: 0.2, ypixel: yRaft*3, xpixel: 0, raft: 'R30'}, 
                                    'R31': {'url': 'https://lsst-camera.slac.stanford.edu/dc05-iiif/2/', y: 0.2, x: 0.2, width: 0.2, ypixel: yRaft*3, xpixel: xRaft, raft: 'R31'}, 
                                    'R32': {'url': 'https://lsst-camera.slac.stanford.edu/dc04-iiif/2/', y: 0.2, x: 0.4, width: 0.2, ypixel: yRaft*3, xpixel: xRaft*2, raft: 'R32'}, 
                                    'R33': {'url': 'https://lsst-camera.slac.stanford.edu/dc09-iiif/2/', y: 0.2, x: 0.6, width: 0.2, ypixel: yRaft*3, xpixel: xRaft*3, raft: 'R33'}, 
                                    'R34': {'url': 'https://lsst-camera.slac.stanford.edu/dc03-iiif/2/', y: 0.2, x: 0.8, width: 0.2, ypixel: yRaft*3, xpixel: xRaft*4, raft: 'R34'}, 
                                    'R40': {'url': 'https://lsst-camera.slac.stanford.edu/dc10-iiif/2/', y: 0.0, x: 0.0, width: 0.2, ypixel: yRaft*4, xpixel: 0, raft: 'R40'}, 
                                    'R41': {'url': 'https://lsst-camera.slac.stanford.edu/dc08-iiif/2/', y: 0.0, x: 0.2, width: 0.2, ypixel: yRaft*4, xpixel: xRaft, raft: 'R41'}, 
                                    'R42': {'url': 'https://lsst-camera.slac.stanford.edu/dc05-iiif/2/', y: 0.0, x: 0.4, width: 0.2, ypixel: yRaft*4, xpixel: xRaft*2, raft: 'R42'}, 
                                    'R43': {'url': 'https://lsst-camera.slac.stanford.edu/dc06-iiif/2/', y: 0.0, x: 0.6, width: 0.2, ypixel: yRaft*4, xpixel: xRaft*3, raft: 'R43'}, 
                                    'R44': {'url': 'https://lsst-camera.slac.stanford.edu/dc10-iiif/2/', y: 0.0, x: 0.8, width: 0.2, ypixel: yRaft*4, xpixel: xRaft*4, raft: 'R44'}
                                };                     
                            }
                            computeImageIdentifier(imageName, raftName, colorMap, bias, scale, source) {
                                return `${imageName}_${raftName}\$colorMap=${colorMap}\$biasCorrection=${bias}\$scale=${scale}\$source=${source}`;
                            }
                            
                            openIdentifier(imageName, raftName, colorMap, bias, scale, source) {
                                this.multi = imageName.startsWith("MC_") && imageName.substring(5, 9) >= '2023';
                                this.identifier = this.computeImageIdentifier(imageName, raftName, colorMap, bias, scale, source);
                                this.open([`${iif2}${this.identifier}/info.json`]);                                
                            }                         
                            
                            open(images) {
                                if (this.multi) {
                                    const re = /(MC_C_\d\d\d\d\d\d\d\d_\d\d\d\d\d\d)_(...)/;
                                    const image = images[0];
                                    const match = image.match(re);
                                    this.geominfo = {};
                                    if (match) {
                                        const raft = match[2];
                                        if (raft === 'all') {
                                            let tiles = [];
                                            for (const key in this.multiGeom) {
                                                let region = this.multiGeom[key];
                                                let tile = {};
                                                tile['tileSource'] = `${region.url}${this.identifier.replace('_all','_'+region.raft)}/info.json`;
                                                tile['geominfoSource'] = `${region.url}${this.identifier.replace('_all','_'+region.raft)}/geominfo.json`;
                                                tile['region'] = region;
                                                tile['x'] = region.x;
                                                tile['y'] = region.y;
                                                tile['width'] = region.width;
                                                tiles.push(tile);
                                            }
                                            super.open(tiles);
                                            for (const tile of tiles) {
                                                this.fetchGeomInfo(tile['geominfoSource'],tile['region'].raft);
                                            }
                                        } else {
                                            const tile = this.multiGeom[raft];
                                            const newImage = image.replace('https://lsst-camera.slac.stanford.edu/iiif/2', tile.url);
                                            super.open(newImage);
                                            this.fetchGeomInfo(`${tile.url}${match[0]}/geominfo.json`, tile.raft);
                                        }
                                    }
                                } else {
                                    super.open(images);
                                    this.fetchGeomInfo(`${iif2}${this.identifier}/geominfo.json`, 'all');
                                }
                            }
                            
                            fetchGeomInfo(url, raft) {
                                fetch(url)
                                    .then((response) => response.json())
                                    .then((myJson) => this.geominfo[raft] = myJson.geometry);
                            }
                            
                            moveHandler(event) {
                                if (this.multi) {
                                    const mousePoint = new OpenSeadragon.Point(event.position.x, event.position.y);
                                    var webPoint = event.position;
                                    var viewportPoint = osd.viewport.pointFromPixel(webPoint);

                                    for (var i=0; i<osd.world.getItemCount(); i++) {
                                        const tiledImage = osd.world.getItemAt(i);
                                        var rect = tiledImage.getBounds(true); // rect in viewport coordinates
                                        if (rect.containsPoint(viewportPoint)) {
                                            const realHoverPosition = tiledImage.viewerElementToImageCoordinates(mousePoint);
                                            // size of the main image
                                            const realSize = tiledImage.getContentSize();
                                            //console.log("Move "+mousePoint+" "+tiledImage+" "+realHoverPosition+" "+realSize);
                                            const offHorizontally = realHoverPosition.x < 0 || realHoverPosition.x > realSize.x;
                                            const offVertically = realHoverPosition.y < 0 || realHoverPosition.y > realSize.y;
                                            const isHovering = !offHorizontally && !offVertically;
                                            if (isHovering) {
                                                let x = Math.floor(realHoverPosition.x);
                                                let y = Math.floor(realSize.y - realHoverPosition.y);
                                                let url = tiledImage.source.getTileUrl(0,0,0);
                                                let re = /.*\d\d\d\d\d\d_(R..).*/;
                                                let match = re.exec(url);
                                                let raft = match[1];
                                                let region = this.multiGeom[raft];
                                                let geometry = this.geominfo[raft];
                                                let text = `x: ${x+region.xpixel}, y: ${y+region.ypixel}`
                                                //console.log(geometry);
                                                let name = '';
                                                let xx = 0;
                                                let yy = 0;
                                                for (const g of geometry) {
                                                    if ((x >= g.x && x < g.x + g.width) && (y >= g.y && y < g.y + g.height)) {
                                                        name = g.raftBay + "/" + g.ccdSlot + "/" + g.segmentName;
                                                        let at = new AffineTransform(g.flatmatrix);
                                                        let xy = at.transform(x, y);
                                                        xx = Math.round(xy[0]);
                                                        yy = Math.round(xy[1]);
                                                        text += `, ${name}(${xx}, ${yy})`;
                                                        let delayedFunction = () => {
                                                            fetch(`${region.url}${this.identifier.replace('_all','_'+region.raft)}/${x},${y}/pixel.json`)
                                                                .then((response) => response.json())
                                                                .then((myJson) => {
                                                                    if (myJson.x == x && myJson.y == y) {
                                                                        $("#xy-coord").text(text + ": " +myJson.pixel);
                                                                    }
                                                                });
                                                        };
                                                        if (timerId) {
                                                            clearTimeout(timerId);
                                                        }
                                                        timerId = setTimeout(delayedFunction, 100);
                                                        break;
                                                    }
                                                }
                                                $("#xy-coord").text(text);                                            
                                            } else {
                                                $("#xy-coord").text("");
                                            }
                                        }
                                    }
                                } else {
                                    const mousePoint = new OpenSeadragon.Point(event.position.x, event.position.y);
                                    const tiledImage = osd.world.getItemAt(0);
                                    const realHoverPosition = tiledImage.viewerElementToImageCoordinates(mousePoint);
                                    // size of the main image
                                    const realSize = tiledImage.getContentSize();
                                    //console.log("Move "+mousePoint+" "+tiledImage+" "+realHoverPosition+" "+realSize);
                                    const offHorizontally = realHoverPosition.x < 0 || realHoverPosition.x > realSize.x;
                                    const offVertically = realHoverPosition.y < 0 || realHoverPosition.y > realSize.y;
                                    const isHovering = !offHorizontally && !offVertically;
                                    if (isHovering) {
                                        let x = Math.floor(realHoverPosition.x);
                                        let y = Math.floor(realSize.y - realHoverPosition.y);
                                        let text = `x: ${x}, y: ${y}`;
                                        let geometry = this.geominfo['all'];
                                        for (const g of geometry) {
                                            if ((x >= g.x && x < g.x + g.width) && (y >= g.y && y < g.y + g.height)) {
                                                let name = g.raftBay + "/" + g.ccdSlot + "/" + g.segmentName;
                                                let at = new AffineTransform(g.flatmatrix);
                                                let xy = at.transform(x, y);
                                                let xx = Math.round(xy[0]);
                                                let yy = Math.round(xy[1]);
                                                text += `, ${name}(${xx}, ${yy})`;
                                                // We want to delay the pixel value fetch unless mouse held in a fixed position
                                                // for a certain time (100ms)
                                                let delayedFunction = function() {
                                                    fetch(`${iif2}${this.identifier}/${x},${y}/pixel.json`)
                                                            .then(function (response) {
                                                                return response.json();
                                                            })
                                                            .then(function (myJson) {
                                                                if (myJson.x == x && myJson.y == y) {
                                                                    $("#xy-coord").text(text + ": " + myJson.pixel);
                                                                }
                                                            });
                                                };
                                                if (timerId) {
                                                    clearTimeout(timerId);
                                                }
                                                timerId = setTimeout(delayedFunction, 100);
                                                break;
                                            }
                                        }
                                        $("#xy-coord").text(text);
                                    } else {
                                        $("#xy-coord").text("");
                                    }                                    
                                }
                            }
                        }

                        const osd = new MyOpenSeadragon();
                        if (imageName !== 'latest') {
                            osd.openIdentifier(imageName, raftName, colorMap, bias, scale, source);
                        }
                        const screenshotInstance = osd.screenshot({
                            showOptions: true, // Default is false
                            keyboardShortcut: 'p', // Default is null
                            showScreenshotControl: true // Default is true
                        });
                        // Get rid of mystery div created by the code above, else toolbar messed up.
                        $('#toolbarDiv').children().last().remove();
                        
                        osd.addHandler('open', openHandler);

                        class AffineTransform {
                            constructor(flatmatrix) {
                                this.m00 = flatmatrix[0];
                                this.m10 = flatmatrix[1];
                                this.m01 = flatmatrix[2];
                                this.m11 = flatmatrix[3];
                                this.m02 = flatmatrix[4];
                                this.m12 = flatmatrix[5];
                            }

                            transform(x, y) {
                                return [x * this.m00 + y * this.m01 + this.m02,
                                    x * this.m10 + y * this.m11 + this.m12];
                            }
                        }

                        const moveHandler = async function (event) {
                            osd.moveHandler(event);
                        };

                        const keyHandler = async function (event) {
                            console.log(event);
                        };

                        let mh = new OpenSeadragon.MouseTracker({"moveHandler": moveHandler, "element": "osd-view"});
                        let kh = new OpenSeadragon.MouseTracker({"keyHandler": keyHandler, "element": "osd-view"});

                    </script>
                    <noscript>
                    <p>OpenSeadragon is not available unless JavaScript is enabled.</p>
                    </noscript>
                </div>
            </div>
            <div id="datastrip">
                <div id="xy-coord">Hello!!!!</div>
            </div>
        </div>
    </body>
</html>
